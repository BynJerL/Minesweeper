<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minesweeper</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .tile {
            width: 30px;
            height: 30px;
            border: 1px solid black;
            font-weight: 700;
            text-align: center;
        }

        .bomb {
            background-color: red;
        }

        /* Number colors */
        .num1 { color: blue; }
        .num2 { color: green; }
        .num3 { color: red; }
        .num4 { color: navy; }
        .num5 { color: brown; }
        .num6 { color: teal; }
        .num7 { color: black; }
        .num8 { color: gray; }

        .hidden  {
            background-color: lightgray;
            color: transparent;
            cursor: pointer;
            user-select: none;
        }

        .tile:not(.hidden) {
            cursor: default;
        }

        #game-container {
            display: inline-block;
            padding: 5px;
        }

        #top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .number-display {
            height: 30px;
            width: 60px;
            color: red;
            background-color: black;
            font-family: 'Courier New', Courier, monospace;
            font-size: 30px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #smiley {
            width: 40px;
            height: 40px;
            font-size: 20px;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div>Total Bombs: <span id="bomb-count"></span></div>
        <div id="top-bar">
            <div id="bomb-display" class="number-display">010</div>
            <button id="smiley">ðŸ™‚</button>
            <div id="timer-display" class="number-display">000</div>
        </div>
        <table class="tile-area"></table>
    </div>
    
    <script>
        const tileArea = document.querySelector(".tile-area");

        /** @param {Array} array */
        function shuffle(array){
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[j], array[i]] = [array[i], array[j]];
            }
            return array;
        }

        const GameManager = {
            mode: "easy",
            totalRow: 9,
            totalCol: 9,
            totalBomb: 10,
            isFirstClick: true,
            isGameOver: false,
            isPlayerWin: false,
            startTiles: [],
            bombTiles: [],
            tileList: [],

            /** @param {string} mode*/ 
            setMode (mode) {
                this.mode = mode;
            },

            checkState() {
                const hiddenTiles = this.tileList.filter(tile => tile.classList.contains("hidden"));
                if (hiddenTiles.length === this.totalBomb) {
                    this.isGameOver = true;
                    this.isPlayerWin = true;
                }
            },

            setBoardData () {
                switch (this.mode) {
                    case "beginner":
                        [this.totalRow, this.totalCol, this.totalBomb] = [8, 8, 10];
                        break;
                    case "easy":
                        [this.totalRow, this.totalCol, this.totalBomb] = [10, 10, 16];
                        break;
                    case "intermediate":
                        [this.totalRow, this.totalCol, this.totalBomb] = [16, 16, 40];
                        break;
                    case "expert":
                        [this.totalRow, this.totalCol, this.totalBomb] = [16, 30, 99];
                        break;
                }
            },

            generateEmptyBoard () {
                tileArea.innerHTML = "";
                for (let row = 0; row < this.totalRow; row++) {
                    const tileRow = document.createElement("tr");
                    for (let col = 0; col < this.totalCol; col++) {
                        const tileCol = document.createElement("td");
                        tileCol.className = "tile hidden";
                        tileCol.setAttribute("data-row", row);
                        tileCol.setAttribute("data-col", col);
                        tileRow.appendChild(tileCol);
                    }
                    tileArea.appendChild(tileRow);
                }
                this.tileList = Array.from(tileArea.querySelectorAll(".tile"));

                this.tileList.forEach((tile, idx) => {
                    tile.addEventListener("click", (e) => {
                        if (this.isFirstClick || this.isGameOver) return;
                        if (this.tileList[idx].classList.contains("bomb")) {
                            this.bombTiles.forEach(bidx => this.revealTile(bidx))
                            this.isGameOver = true;
                            this.isPlayerWin = false;
                            return;
                        }
                        this.revealTile(idx);
                        this.checkState();
                    });
                });
            },

            setStartTiles (row, col) {
                this.startTiles = [];
                const refRow = row, 
                refCol = col;

                for (let dr = -1; dr <= 1; dr++) {
                    for (let dc = -1; dc <= 1; dc++) {
                        const r = refRow + dr, 
                        c = refCol + dc;
                        if (r >= 0 &&
                            r < this.totalRow && 
                            c >= 0 && 
                            c < this.totalCol) {
                            this.startTiles.push(r * this.totalCol + c);
                        }
                    }
                }
            },

            setBombTiles () {
                let tileNumbers = [];
                for (let num = 0; num < this.totalRow * this.totalCol; num++) tileNumbers.push(num);
                this.bombTiles = shuffle(tileNumbers.filter(i => !this.startTiles.includes(i))).slice(0, this.totalBomb);

                this.tileList.forEach((tile, idx) => {
                    const dCol = parseInt(tile.getAttribute("data-col")),
                          dRow = parseInt(tile.getAttribute("data-row"));
                    const dIdx = dRow * this.totalCol + dCol;
                    if (idx !== dIdx) {
                        // error function
                        return;
                    }

                    if (this.bombTiles.includes(dIdx)) {
                        tile.classList.add("bomb");
                        tile.textContent = "âš«";
                    } else {
                        tile.classList.remove("bomb");
                        tile.textContent = "";
                    }
                });

                this.tileList.forEach(tile => {
                    if (tile.classList.contains("bomb")) return;

                    const dCol = parseInt(tile.getAttribute("data-col")),
                          dRow = parseInt(tile.getAttribute("data-row"));
                    const startRow = (dRow === 0)? 0: dRow - 1;
                    const startCol = (dCol === 0)? 0: dCol - 1;
                    const endRow = (dRow === this.totalRow - 1)? dRow: dRow + 1;
                    const endCol = (dCol === this.totalCol - 1)? dCol: dCol + 1; 

                    let bombNearby = 0;

                    for (let row = startRow; row <= endRow; row++) {
                        for (let col = startCol; col <= endCol; col++) {
                            const sidx = row * this.totalCol + col;

                            if (this.tileList[sidx].classList.contains("bomb")) {
                                bombNearby++;
                            }
                        }
                    }

                    tile.textContent = (bombNearby)? bombNearby: "";
                    tile.classList.add(`num${bombNearby}`);
                });
            },

            revealTile(idx) {
                const currentTile = this.tileList[idx];
                if (!currentTile.classList.contains("hidden")) return;

                currentTile.classList.remove("hidden");

                if (currentTile.textContent === "") {
                    const dRow = parseInt(currentTile.getAttribute("data-row"));
                    const dCol = parseInt(currentTile.getAttribute("data-col"));

                    const startRow = (dRow === 0)? 0: dRow - 1;
                    const startCol = (dCol === 0)? 0: dCol - 1;
                    const endRow = (dRow === this.totalRow - 1)? dRow: dRow + 1;
                    const endCol = (dCol === this.totalCol - 1)? dCol: dCol + 1; 

                    for (let row = startRow; row <= endRow; row++) {
                        for (let col = startCol; col <= endCol; col++) {
                            const sidx = row * this.totalCol + col;

                            if (!this.tileList[sidx].classList.contains("bomb")) {
                                this.revealTile(sidx);
                            }
                        }
                    }
                }
            },

            initializeTileArea(idx) {
                const tile = this.tileList[idx];
                const row = parseInt(tile.getAttribute("data-row"));
                const col = parseInt(tile.getAttribute("data-col"));
                this.setStartTiles(row, col);
                this.setBombTiles();
            },

            start() {
                this.setBoardData();
                this.generateEmptyBoard();
                document.getElementById("bomb-count").textContent = this.totalBomb;

                this.tileList.forEach((tile, idx) => {
                    tile.addEventListener("click", (e) => {
                        if (this.isFirstClick) {
                            this.initializeTileArea(idx);
                            this.isFirstClick = false;
                            this.revealTile(idx);
                        }
                    });
                });
            }
        };

        GameManager.setMode("beginner");
        GameManager.start();
    </script>
</body>
</html>